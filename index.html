<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Triad Experiment</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <!-- PARTICIPANT INFORMATION SCREEN -->
  <div id="info">
    <h1>Participant Information</h1>
    <div style="text-align: left; max-width: 800px; margin: 0 auto; color: white;">
      <h2>Inference in perception and oculomotor control</h2>
      <p><strong>Researcher:</strong> Dr. Emma Stewart<br>
      <strong>Queen Mary Ethics Reference:</strong> PSY2024-22</p>

      <h3>General Information:</h3>
      <p>We would like to invite you to be part of this research project, if you would like to. You should only agree to take part if you want to, it is entirely up to you. If you choose not to take part, there won't be any disadvantages for you and you will hear no more about it.</p>

      <p>Please read the following information carefully before you decide to take part; this will tell you why the research is being done and what you will be asked to do if you take part. Please ask if there is anything that is not clear or if you would like more information.</p>

      <p>If you decide to take part, you will be asked to sign the attached form to say that you agree. You are still free to withdraw at any time and without giving a reason.</p>

      <h3>Purpose of study:</h3>
      <p>The purpose of this study is to gain a deeper understanding of the mechanisms underlying human visual perception.</p>

      <h3>Procedure:</h3>
      <p>During the course of the experiment you will be presented with a series of images or movies of objects on the screen. You will be asked to make subjective decisions about the images (e.g. choosing objects to report, and matching objects) and to provide responses using the screen, mouse or keyboard. Specific details about the images, judgments and responses are provided on the Instruction Page. The duration of the experiment depends on the speed of your responses but is expected to be roughly 5 minutes.</p>

      <h3>Potential risks, side effects, or discomfort:</h3>
      <p>No known risks or side effects are associated with participation in this experiment. Extensive viewing of a screen can lead to discomfort.</p>

      <h3>Uses and benefits of the experiment:</h3>
      <p>There are no further benefits to you as a result of participating in this experiment, other than monetary remuneration. You will be paid 9 GBP an hour for your time. However, we seek to use the results to make inferences about human brain processes underlying visual perception. We aim to publish our conclusions in scientific journals. In the long run, results like the ones from this experiment may be useful for numerous other research areas, including the development of computer graphics techniques, machine learning and artificial intelligence, and the diagnosis of psychological disorders.</p>

      <h3>What will happen with my data?</h3>
      <p>All data collected will be fully anonymized... (rest of your paragraph)...</p>

      <p>Please read <a href="https://www.qmul.ac.uk/governance-and-legal-services/media/arcs/policyzone/Privacy-Notice-for-Research-Participants.pdf" target="_blank" style="color:#99ccff;">Queen Mary's privacy notice for research participants</a>.</p>

      <h3>What will happen if I want to withdraw from this study?</h3>
      <p>You are free to withdraw at any point throughout the duration of the experiment... (rest of your paragraph)...</p>

      <p>If you have any questions...<br>
      Georgie Keggin: g.keggin@qmul.ac.uk</p>

      <button onclick="showConsent()" style="margin-top: 20px;">Continue to Consent Form</button>
    </div>
  </div>

  <!-- CONSENT FORM -->
  <div id="consent" style="display:none;">
    <h1>Informed Consent</h1>
    <form id="consent-form">
      <p><strong>Please read and respond to all the following statements:</strong></p>
      <label><input type="checkbox" required> I understand that my participation is voluntary...</label><br>
      <label><input type="checkbox" required> I understand that my data will be accessed by the research team.</label><br>
      <label><input type="checkbox" required> I understand my data will be stored securely...</label><br>
      <label><input type="checkbox" required> I understand that withdrawing before submission means no data is stored.</label><br>
      <label><input type="checkbox" required> I understand my data may be reused in anonymized form.</label><br>
      <label><input type="checkbox" required> I agree to take part in this study.</label><br><br>

      <h3>Demographics</h3>
      <label>What is your age? <input type="number" id="age" required></label><br>
      <label>What is your sex?</label><br>
      <input type="radio" name="sex" value="Male" required> Male<br>
      <input type="radio" name="sex" value="Female"> Female<br>
      <input type="radio" name="sex" value="Other"> Other<br><br>

      <button type="submit">Continue</button>
    </form>
  </div>

  <!-- INSTRUCTIONS -->
  <div id="instructions" style="display:none; text-align:center; color:white;">
    <h1>Instructions</h1>
    <p>You will see a series of trials. On each trial, there will be a reference object and two options below.</p>
    <p>Your task is to choose the object most similar in shape and orientation to the reference.</p>
    <p>Click the image that matches best. Please respond as quickly and accurately as you can.</p>
    <button onclick="startExperiment()">Start</button>
  </div>

  <!-- EXPERIMENT -->
  <div id="experiment" style="display:none;">
    <div id="trial">
      <p id="trial-count"></p>
      <div id="images">
        <div>
          <p><strong>Reference</strong></p>
          <img id="reference" class="stim" />
        </div>
        <div id="choices">
          <div>
            <p>Option A</p>
            <img id="choice-left" class="stim choice" data-side="left" />
          </div>
          <div>
            <p>Option B</p>
            <img id="choice-right" class="stim choice" data-side="right" />
          </div>
        </div>
      </div>
    </div>
    <div id="end" style="display:none;">
      <h2>Experiment Complete</h2>
      <p>Click below to download your data.</p>
      <button id="download">Download Results</button>
    </div>
  </div>

  <!-- SCRIPTS -->
  <script>
    function showConsent() {
      document.getElementById("info").style.display = "none";
      document.getElementById("consent").style.display = "block";
    }

    function startExperiment() {
      document.getElementById("instructions").style.display = "none";
      document.getElementById("experiment").style.display = "block";
      showTrial(trialIndex);
    }

    document.getElementById("consent-form").addEventListener("submit", function(e) {
      e.preventDefault();
      document.getElementById("consent").style.display = "none";
      document.getElementById("instructions").style.display = "block";
    });

    const totalObjects = 75;
    const totalRotations = 75;
    const trials = [];
    const results = [];
    const sdNear = 10;
    const minDiff = 10;
    let trialIndex = 0;

    const getParticipantID = () => {
      const params = new URLSearchParams(window.location.search);
      return params.get("participant") || "anonymous";
    };

    function sampleRotation(ref, sd = 10, min = 1) {
      let val;
      do {
        val = Math.round(ref + randn_bm() * sd);
      } while (Math.abs(val - ref) < min || val < 0 || val >= totalRotations);
      return val;
    }

    function randn_bm() {
      let u = 0, v = 0;
      while (u === 0) u = Math.random();
      while (v === 0) v = Math.random();
      return Math.sqrt(-2.0 * Math.log(u)) * Math.cos(2.0 * Math.PI * v);
    }

    function shuffle(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
      return array;
    }

    for (let obj = 1; obj <= totalObjects; obj++) {
      const ref = Math.floor(Math.random() * totalRotations);
      const near = sampleRotation(ref, sdNear, minDiff);
      let far;
      do {
        far = sampleRotation(ref, sdNear * 2, minDiff);
      } while (Math.abs(far - near) < minDiff || far === ref);

      const sides = shuffle(["left", "right"]);
      const leftRotation = sides[0] === "near" ? near : far;
      const rightRotation = sides[1] === "near" ? near : far;

      const trial = {
        obj,
        ref,
        near,
        far,
        leftRotation,
        rightRotation,
        leftType: leftRotation === near ? "near" : "far",
        rightType: rightRotation === near ? "near" : "far",
        participant: getParticipantID()
      };

      trials.push(trial);
    }

    function showTrial(index) {
      const t = trials[index];
      document.getElementById("trial-count").textContent = `Trial ${index + 1} of ${trials.length}`;
      document.getElementById("reference").src = `objs/${t.obj}/${t.obj}rot_${t.ref}.webp`;
      document.getElementById("choice-left").src = `objs/${t.obj}/${t.obj}rot_${t.leftRotation}.webp`;
      document.getElementById("choice-right").src = `objs/${t.obj}/${t.obj}rot_${t.rightRotation}.webp`;
    }

    function recordResponse(choiceSide) {
      const t = trials[trialIndex];
      const choiceType = choiceSide === "left" ? t.leftType : t.rightType;

      results.push({
        participant: t.participant,
        object: t.obj,
        ref: t.ref,
        near: t.near,
        far: t.far,
        leftRotation: t.leftRotation,
        rightRotation: t.rightRotation,
        leftType: t.leftType,
        rightType: t.rightType,
        choiceSide,
        choiceType
      });

      trialIndex++;
      if (trialIndex < trials.length) {
        showTrial(trialIndex);
      } else {
        document.getElementById("trial").style.display = "none";
        document.getElementById("end").style.display = "block";
      }
    }

    document.querySelectorAll(".choice").forEach(el => {
      el.addEventListener("click", e => {
        const side = e.target.dataset.side;
        recordResponse(side);
      });
    });

    document.getElementById("download").addEventListener("click", () => {
      const header = Object.keys(results[0]).join(",");
      const rows = results.map(r => Object.values(r).join(",")).join("\n");
      const csv = `${header}\n${rows}`;
      const blob = new Blob([csv], { type: "text/csv" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `triad_results_${getParticipantID()}.csv`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    });
  </script>
</body>
</html>

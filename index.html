<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Triad Experiment</title>
  <link rel="stylesheet" href="style.css" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
</head>
<body>
  <!-- PARTICIPANT INFORMATION -->
  <div id="info">
    <h1>Participant Information</h1>
    <div class="content-box">
      <h2>Inference in perception and oculomotor control</h2>
      <p><strong>Researcher:</strong> Dr. Emma Stewart<br><strong>Queen Mary Ethics Reference:</strong> PSY2024-22</p>
      <hr>
      <p>We would like to invite you to be part of this research project... (full text)</p>
      <p>Please read <a href="https://www.qmul.ac.uk/governance-and-legal-services/media/arcs/policyzone/Privacy-Notice-for-Research-Participants.pdf" target="_blank">Queen Mary's privacy notice</a>.</p>
      <p>If you have any questions, contact Georgie Keggin: g.keggin@qmul.ac.uk</p>
      <button class="btn" onclick="showConsent()">Continue to Consent Form</button>
    </div>
  </div>

  <!-- CONSENT FORM -->
  <div id="consent" style="display:none;">
    <h1>Informed Consent</h1>
    <form id="consent-form" class="content-box">
      <p><strong>Please tick all boxes to continue:</strong></p>
      <label><input type="checkbox" required /> I understand that my participation is voluntary.</label>
      <label><input type="checkbox" required /> I understand that my data will be accessed by the research team.</label>
      <label><input type="checkbox" required /> I understand my data will be stored securely.</label>
      <label><input type="checkbox" required /> I understand I can withdraw at any time.</label>
      <label><input type="checkbox" required /> I agree to take part in this study.</label>
      <h3>Demographics</h3>
      <label>Age: <input type="number" id="age" required></label>
      <label>Sex:
        <input type="radio" name="sex" value="Male" required> Male
        <input type="radio" name="sex" value="Female"> Female
        <input type="radio" name="sex" value="Other"> Other
      </label>
      <button type="submit" class="btn">Continue</button>
    </form>
  </div>

  <!-- INSTRUCTIONS -->
  <div id="instructions" style="display:none;">
    <div class="content-box">
      <h1>Instructions</h1>
      <p>You will see a reference object and two options below.</p>
      <p>Choose the object most similar in shape and orientation to the reference.</p>
      <p>Click the image that matches best. Please respond as quickly and accurately as you can.</p>
      <button class="btn" onclick="startExperiment()">Start</button>
    </div>
  </div>

  <!-- EXPERIMENT -->
  <div id="experiment" style="display:none;">
    <div id="trial">
      <p id="trial-count"></p>
      <div id="images">
        <div>
          <p><strong>Reference</strong></p>
          <img id="reference" class="stim" />
        </div>
        <div id="choices">
          <div>
            <p>Option A</p>
            <img id="choice-left" class="stim choice" data-side="left" />
          </div>
          <div>
            <p>Option B</p>
            <img id="choice-right" class="stim choice" data-side="right" />
          </div>
        </div>
      </div>
    </div>
    <div id="end" style="display:none;">
      <h2>Experiment Complete</h2>
      <p>Thank you for participating!</p>
      <a class="btn" href="https://app.prolific.com/submissions/complete?cc=CTC44D4K">Submit on Prolific</a>
    </div>
  </div>

  <!-- SCRIPT -->
  <script>
    const totalObjects = 75;
    const totalRotations = 37;
    const sdNear = 2;
    const minDiff = 2;
    const trials = [];
    const results = [];
    let trialIndex = 0;
    let trialStartTime = null;
    let participantInfo = { age: "", sex: "", participant: "" };

    function getParticipantID() {
      const params = new URLSearchParams(window.location.search);
      return params.get("PROLIFIC_PID") || "anonymous";
    }

    function randn_bm() {
      let u = 0, v = 0;
      while (u === 0) u = Math.random();
      while (v === 0) v = Math.random();
      return Math.sqrt(-2.0 * Math.log(u)) * Math.cos(2.0 * Math.PI * v);
    }

    function sampleRotation(ref, sd = 2, min = 1) {
      let val;
      do {
        val = Math.round(ref + randn_bm() * sd);
      } while (Math.abs(val - ref) < min || val < 0 || val >= totalRotations);
      return val;
    }

    function shuffle(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
      return array;
    }

    for (let obj = 1; obj <= totalObjects; obj++) {
      const ref = Math.floor(Math.random() * totalRotations);
      let near = sampleRotation(ref, sdNear, minDiff);
      let far;
      do {
        far = sampleRotation(ref, sdNear * 2, minDiff);
      } while (Math.abs(far - near) < minDiff || far === ref || near === ref || far === near);

      const nearDiff = Math.abs(near - ref);
      const farDiff = Math.abs(far - ref);
      if (farDiff < nearDiff) [near, far] = [far, near];

      const sides = shuffle(["near", "far"]);
      trials.push({
        obj,
        ref,
        near,
        far,
        leftRotation: sides[0] === "near" ? near : far,
        rightRotation: sides[1] === "near" ? near : far,
        leftType: sides[0],
        rightType: sides[1],
        isCatch: false
      });
    }

    function showTrial(index) {
      const t = trials[index];
      document.getElementById("trial-count").textContent = `Trial ${index + 1} of ${trials.length}`;
      document.getElementById("reference").src = `objs/${t.obj}/${t.obj}rot_${t.ref}.webp`;
      document.getElementById("choice-left").src = `objs/${t.obj}/${t.obj}rot_${t.leftRotation}.webp`;
      document.getElementById("choice-right").src = `objs/${t.obj}/${t.obj}rot_${t.rightRotation}.webp`;
      trialStartTime = Date.now();
    }

    function recordResponse(choiceSide) {
      const t = trials[trialIndex];
      const rt = (Date.now() - trialStartTime) / 1000;

      const validRT = rt >= 0.1 && rt <= 10;

      if (validRT) {
        results.push({
          timestamp: new Date().toISOString(),
          participant: participantInfo.participant,
          age: participantInfo.age,
          sex: participantInfo.sex,
          object: t.obj,
          ref: t.ref,
          near: t.near,
          far: t.far,
          leftRotation: t.leftRotation,
          rightRotation: t.rightRotation,
          leftType: t.leftType,
          rightType: t.rightType,
          choiceSide,
          choiceType: choiceSide === "left" ? t.leftType : t.rightType,
          reactionTime: rt.toFixed(3),
          isCatch: t.isCatch
        });
      } else {
        console.warn("RT out of range:", rt);
      }

      trialIndex++;
      if (trialIndex < trials.length) {
        showTrial(trialIndex);
      } else {
        document.getElementById("trial").style.display = "none";
        document.getElementById("end").style.display = "block";
        sendDataToGoogleSheet();
      }
    }

    function sendDataToGoogleSheet() {
      fetch("https://script.google.com/macros/s/AKfycbx5TiTasSIH1jZ43WAvXNO9qNbXhLdYQZ2drrx9M3RG2My3MgrMEYOPoj_vQ3NZXSvz/exec", {
        method: "POST",
        body: JSON.stringify(results),
        headers: { "Content-Type": "application/json" }
      })
      .then(res => console.log("✅ Submitted to Google Sheets"))
      .catch(err => console.error("❌ Submission error:", err));
    }

    document.querySelectorAll(".choice").forEach(el => {
      el.addEventListener("click", e => {
        const side = e.target.dataset.side;
        recordResponse(side);
      });
    });

    function showConsent() {
      document.getElementById("info").style.display = "none";
      document.getElementById("consent").style.display = "block";
    }

    document.getElementById("consent-form").addEventListener("submit", function(e) {
      e.preventDefault();
      participantInfo = {
        participant: getParticipantID(),
        age: document.getElementById("age").value,
        sex: document.querySelector('input[name="sex"]:checked')?.value
      };
      document.getElementById("consent").style.display = "none";
      document.getElementById("instructions").style.display = "block";
    });

    function startExperiment() {
      document.getElementById("instructions").style.display = "none";
      document.getElementById("experiment").style.display = "block";
      showTrial(trialIndex);
    }
  </script>
</body>
</html>

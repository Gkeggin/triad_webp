<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Triad Experiment</title>
  <link rel="stylesheet" href="style.css" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
</head>
<body>
  <!-- PARTICIPANT INFORMATION -->
  <div id="info">
    <h1>Participant Information</h1>
    <div class="content-box">
      <h2>Inference in perception and oculomotor control</h2>
      <p><strong>Researcher:</strong> Dr. Emma Stewart<br><strong>Queen Mary Ethics Reference:</strong> PSY2024-22</p>
      <hr>
      <h3>General Information:</h3>
      <p>We would like to invite you to be part of this research project, if you would like to. You should only agree to take part if you want to—it is entirely up to you. If you choose not to take part, there won't be any disadvantages for you and you will hear no more about it.</p>
      <p>Please read the following information carefully before you decide to take part; this will tell you why the research is being done and what you will be asked to do if you take part. Please ask if there is anything that is not clear or if you would like more information.</p>
      <p>If you decide to take part, you will be asked to sign the attached form to say that you agree. You are still free to withdraw at any time and without giving a reason.</p>

      <h3>Purpose of study:</h3>
      <p>The purpose of this study is to gain a deeper understanding of the mechanisms underlying human visual perception.</p>

      <h3>Procedure:</h3>
      <p>During the course of the experiment you will be presented with a series of images or movies of objects on the screen. You will be asked to make subjective decisions about the images (e.g. choosing objects to report, and matching objects) and to provide responses using the screen, mouse or keyboard. Specific details about the images, judgments and responses are provided on the Instruction Page. The duration of the experiment depends on the speed of your responses but is expected to be roughly 5 minutes.</p>

      <h3>Potential risks, side effects, or discomfort:</h3>
      <p>No known risks or side effects are associated with participation in this experiment. Extensive viewing of a screen can lead to discomfort.</p>

      <h3>Uses and benefits of the experiment:</h3>
      <p>There are no further benefits to you as a result of participating in this experiment, other than monetary remuneration. You will be paid 9 GBP an hour for your time. However, we seek to use the results to make inferences about human brain processes underlying visual perception. We aim to publish our conclusions in scientific journals. In the long run, results like the ones from this experiment may be useful for numerous other research areas, including the development of computer graphics techniques, machine learning and artificial intelligence, and the diagnosis of psychological disorders.</p>

      <h3>What will happen with my data?</h3>
      <p>All data collected will be fully anonymized. It will not be possible to identify you from your data. Anonymous data will be stored on encrypted computers at Queen Mary University of London, in line with GDPR and data protection requirements.</p>
      <p>Please read <a href="https://www.qmul.ac.uk/governance-and-legal-services/media/arcs/policyzone/Privacy-Notice-for-Research-Participants.pdf" target="_blank">Queen Mary's privacy notice for research participants</a>.</p>

      <h3>What will happen if I want to withdraw?</h3>
      <p>You are free to withdraw at any point throughout the experiment by closing your browser. If you withdraw before the end, no data will be stored. If you withdraw after the experiment is complete, we cannot remove your anonymous data.</p>

      <p>If you have any questions, please contact Georgie Keggin: g.keggin@qmul.ac.uk</p>
      <button class="btn" onclick="showConsent()">Continue to Consent Form</button>
    </div>
  </div>

  <!-- CONSENT -->
  <div id="consent" style="display:none;">
    <h1>Informed Consent</h1>
    <form id="consent-form" class="content-box">
      <p><strong>Please tick all boxes to continue:</strong></p>
      <label><input type="checkbox" required /> I understand that my participation is voluntary.</label>
      <label><input type="checkbox" required /> I understand that my data will be accessed by the research team.</label>
      <label><input type="checkbox" required /> I understand my data will be stored securely.</label>
      <label><input type="checkbox" required /> I understand that withdrawing before submission means no data is stored.</label>
      <label><input type="checkbox" required /> I agree to take part in this study.</label>

      <h3>Demographics</h3>
      <label>Age: <input type="number" id="age" required></label>
      <label>Sex:
        <input type="radio" name="sex" value="Male" required> Male
        <input type="radio" name="sex" value="Female"> Female
        <input type="radio" name="sex" value="Other"> Other
      </label>

      <button type="submit" class="btn">Continue</button>
    </form>
  </div>

  <!-- INSTRUCTIONS -->
  <div id="instructions" style="display:none;">
    <div class="content-box">
      <h1>Instructions</h1>
      <p>On each trial, you’ll see a reference object and two comparison options below it.</p>
      <p>Your task is to choose the option that most closely matches the reference in shape and orientation.</p>
      <p>Please respond as quickly and accurately as you can.</p>
      <button class="btn" onclick="startExperiment()">Start</button>
    </div>
  </div>

  <!-- EXPERIMENT -->
  <div id="experiment" style="display:none;">
    <div id="trial">
      <p id="trial-count"></p>
      <div id="images">
        <div>
          <p><strong>Reference</strong></p>
          <img id="reference" class="stim" />
        </div>
        <div id="choices">
          <div>
            <p>Option A</p>
            <img id="choice-left" class="stim choice" data-side="left" />
          </div>
          <div>
            <p>Option B</p>
            <img id="choice-right" class="stim choice" data-side="right" />
          </div>
        </div>
      </div>
    </div>
    <div id="end" style="display:none;">
      <h2>Experiment Complete</h2>
      <p>Thank you for participating!</p>
      <a class="btn" href="https://app.prolific.com/submissions/complete?cc=CTC44D4K">Submit on Prolific</a>
    </div>
  </div>

  <!-- SCRIPT -->
  <script>
    const totalObjects = 75;
    const totalRotations = 37; // 0–180 in 5° steps
    const trials = [];
    const results = [];
    const sdNear = 2;
    const minDiff = 2;
    let trialIndex = 0;

    let participantInfo = { age: "", sex: "", participant: "" };

    function getParticipantID() {
      const params = new URLSearchParams(window.location.search);
      return params.get("PROLIFIC_PID") || "anonymous";
    }

    function randn_bm() {
      let u = 0, v = 0;
      while (u === 0) u = Math.random();
      while (v === 0) v = Math.random();
      return Math.sqrt(-2.0 * Math.log(u)) * Math.cos(2.0 * Math.PI * v);
    }

    function sampleRotation(ref, sd = 2, min = 1) {
      let val;
      do {
        val = Math.round(ref + randn_bm() * sd);
      } while (Math.abs(val - ref) < min || val < 0 || val >= totalRotations);
      return val;
    }

    function shuffle(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
      return array;
    }

    for (let obj = 1; obj <= totalObjects; obj++) {
      const ref = Math.floor(Math.random() * totalRotations);
      let near = sampleRotation(ref, sdNear, minDiff);
      let far;
      do {
        far = sampleRotation(ref, sdNear * 2, minDiff);
      } while (Math.abs(far - near) < minDiff || far === ref || near === ref || far === near);

      const nearDiff = Math.abs(near - ref);
      const farDiff = Math.abs(far - ref);
      if (farDiff < nearDiff) [near, far] = [far, near];

      const sides = shuffle(["near", "far"]);
      const leftRotation = sides[0] === "near" ? near : far;
      const rightRotation = sides[1] === "near" ? near : far;

      const trial = {
        obj,
        ref,
        near,
        far,
        leftRotation,
        rightRotation,
        leftType: sides[0],
        rightType: sides[1]
      };

      trials.push(trial);
    }

    function showTrial(index) {
      const t = trials[index];
      document.getElementById("trial-count").textContent = `Trial ${index + 1} of ${trials.length}`;
      document.getElementById("reference").src = `objs/${t.obj}/${t.obj}rot_${t.ref}.webp`;
      document.getElementById("choice-left").src = `objs/${t.obj}/${t.obj}rot_${t.leftRotation}.webp`;
      document.getElementById("choice-right").src = `objs/${t.obj}/${t.obj}rot_${t.rightRotation}.webp`;
    }

    function recordResponse(choiceSide) {
      const t = trials[trialIndex];
      const choiceType = choiceSide === "left" ? t.leftType : t.rightType;

      results.push({
        timestamp: new Date().toISOString(),
        participant: participantInfo.participant,
        age: participantInfo.age,
        sex: participantInfo.sex,
        object: t.obj,
        ref: t.ref,
        near: t.near,
        far: t.far,
        leftRotation: t.leftRotation,
        rightRotation: t.rightRotation,
        leftType: t.leftType,
        rightType: t.rightType,
        choiceSide,
        choiceType
      });

      trialIndex++;
      if (trialIndex < trials.length) {
        showTrial(trialIndex);
      } else {
        document.getElementById("trial").style.display = "none";
        document.getElementById("end").style.display = "block";
      }
    }

    document.querySelectorAll(".choice").forEach(el => {
      el.addEventListener("click", e => {
        const side = e.target.dataset.side;
        recordResponse(side);
      });
    });

    function showConsent() {
      document.getElementById("info").style.display = "none";
      document.getElementById("consent").style.display = "block";
    }

    document.getElementById("consent-form").addEventListener("submit", function(e) {
      e.preventDefault();
      participantInfo = {
        participant: getParticipantID(),
        age: document.getElementById("age").value,
        sex: document.querySelector('input[name="sex"]:checked')?.value
      };
      document.getElementById("consent").style.display = "none";
      document.getElementById("instructions").style.display = "block";
    });

    function startExperiment() {
      document.getElementById("instructions").style.display = "none";
      document.getElementById("experiment").style.display = "block";
      showTrial(trialIndex);
    }
  </script>
</body>
</html>
